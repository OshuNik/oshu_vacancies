// settings.js ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
(function() {
  'use strict';

  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  if (tg && tg.expand) tg.expand();

  const CFG = window.APP_CONFIG;
  const UTIL = window.utils;

  if (!CFG || !UTIL) {
    alert("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω config.js –∏–ª–∏ utils.js!");
    console.error('settings.js: CFG –∏–ª–∏ UTIL –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
    return;
  }

  const { uiToast, safeAlert, showCustomConfirm, createSupabaseHeaders, escapeHtml } = UTIL;

  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  const CHANNEL_VALIDATION = {
    MIN_LENGTH: 5,
    MAX_LENGTH: 32,
    PATTERN: /^[a-zA-Z0-9_]+$/
  };

  const API_ENDPOINTS = {
    SETTINGS: `${CFG.SUPABASE_URL}/rest/v1/settings`,
    CHANNELS: `${CFG.SUPABASE_URL}/rest/v1/channels`,
    DEFAULT_CHANNELS: `${CFG.SUPABASE_URL}/rest/v1/default_channels`
  };

  const MESSAGES = {
    ERRORS: {
      CHANNEL_EXISTS: '–¢–∞–∫–æ–π –∫–∞–Ω–∞–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–µ!',
      INVALID_FORMAT: `–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç username. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è (${CHANNEL_VALIDATION.MIN_LENGTH}-${CHANNEL_VALIDATION.MAX_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤).`,
      ADD_FAILED: '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª',
      LOAD_FAILED: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–Ω–∞–ª—ã',
      DELETE_FAILED: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª',
      UPDATE_FAILED: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å'
    },
    SUCCESS: {
      CHANNEL_ADDED: '–ö–∞–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!',
      CHANNEL_DELETED: '–ö–∞–Ω–∞–ª —É–¥–∞–ª—ë–Ω',
      CHANNEL_TOGGLED: '–ö–∞–Ω–∞–ª –≤–∫–ª—é—á—ë–Ω',
      CHANNEL_DISABLED: '–ö–∞–Ω–∞–ª –≤—ã–∫–ª—é—á–µ–Ω',
      KEYWORDS_SAVED: '–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã',
      DEFAULTS_LOADED: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã.',
      ALL_DELETED: '–í—Å–µ –∫–∞–Ω–∞–ª—ã —É–¥–∞–ª–µ–Ω—ã.'
    }
  };

  const settingsTabButtons = document.querySelectorAll('.settings-tab-button');
  const settingsTabContents = document.querySelectorAll('.settings-tab-content');
  const keywordsInput = document.getElementById('keywords-input');
  const keywordsDisplay = document.getElementById('current-keywords-display');
  const saveBtn = document.getElementById('save-button');
  const loadDefaultsBtn = document.getElementById('load-defaults-btn');
  const addChannelBtn = document.getElementById('add-channel-btn');
  const channelInput = document.getElementById('channel-input');
  const channelsListContainer = document.getElementById('channels-list');
  const deleteAllBtn = document.getElementById('delete-all-btn');

  /**
   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç ID –∫–∞–Ω–∞–ª–∞
   * @param {string} input - –í—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (username, t.me —Å—Å—ã–ª–∫–∞ –∏–ª–∏ @username)
   * @returns {string|null} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π channelId –∏–ª–∏ null –ø—Ä–∏ –æ—à–∏–±–∫–µ
   */
  function validateAndFormatChannelId(input) {
    if (!input) return null;
    
    let channelId = input.trim();
    console.log('üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–Ω–∞–ª–∞:', channelId);
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ t.me —Å—Å—ã–ª–æ–∫
    if (channelId.includes('t.me/')) {
      channelId = '@' + channelId.split('t.me/')[1].split('/')[0];
      console.log('üîó –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –∏–∑ t.me:', channelId);
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ @ –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    if (!channelId.startsWith('@')) channelId = '@' + channelId;
    
    console.log('‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π channelId:', channelId);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è username
    const username = channelId.substring(1);
    if (!CHANNEL_VALIDATION.PATTERN.test(username) || 
        username.length < CHANNEL_VALIDATION.MIN_LENGTH || 
        username.length > CHANNEL_VALIDATION.MAX_LENGTH) {
      safeAlert(MESSAGES.ERRORS.INVALID_FORMAT);
      return null;
    }
    
    return channelId;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
   * @param {string} channelId - ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
   * @returns {Promise<boolean>} true –µ—Å–ª–∏ –∫–∞–Ω–∞–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, false –µ—Å–ª–∏ –Ω–µ—Ç
   */
  async function isChannelExists(channelId) {
    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞...');
    try {
      const response = await fetch(`${API_ENDPOINTS.CHANNELS}?channel_id=eq.${encodeURIComponent(channelId)}&select=id`, {
        headers: createSupabaseHeaders()
      });
      
      if (response.ok) {
        const existingChannels = await response.json();
        console.log('üìä –ù–∞–π–¥–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–∞–Ω–∞–ª–æ–≤:', existingChannels.length);
        return existingChannels.length > 0;
      } else {
        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:', response.status, response.statusText);
        return false;
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
      return false;
    }
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –µ–≥–æ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
   * @param {string} channelId - ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
   * @returns {Promise<Object>} –°–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –∫–∞–Ω–∞–ª–∞
   */
  async function createChannel(channelId) {
    const newChannelData = { 
      channel_id: channelId, 
      channel_title: channelId, 
      is_enabled: true 
    };
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ API:', newChannelData);
    console.log('üåê URL:', API_ENDPOINTS.CHANNELS);
    
    const response = await fetch(API_ENDPOINTS.CHANNELS, {
      method: 'POST',
      headers: createSupabaseHeaders({ prefer: 'return=representation' }),
      body: JSON.stringify(newChannelData)
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} ${response.statusText}. ${errorText}`);
    }
    
    const data = await response.json();
    if (data && data.length > 0) {
      renderChannel(data[0]);
      channelInput.value = '';
      uiToast(MESSAGES.SUCCESS.CHANNEL_ADDED);
      return data[0];
    } else {
      throw new Error('API –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–º –∫–∞–Ω–∞–ª–µ');
    }
  }

  settingsTabButtons.forEach(button => {
    button.addEventListener('click', () => {
      settingsTabButtons.forEach(btn => btn.classList.remove('active'));
      settingsTabContents.forEach(content => content.classList.remove('active'));
      button.classList.add('active');
      const targetContent = document.getElementById(button.dataset.target);
      if (targetContent) targetContent.classList.add('active');
    });
  });

  async function loadKeywords() {
    if (!keywordsDisplay) {
        console.error('loadKeywords: —ç–ª–µ–º–µ–Ω—Ç keywordsDisplay –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    saveBtn.disabled = true;
    keywordsDisplay.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    try {
      const response = await fetch(`${API_ENDPOINTS.SETTINGS}?select=keywords`, {
        headers: createSupabaseHeaders()
      });
      if (!response.ok) throw new Error('Network response was not ok');
      const data = await response.json();
      const keywords = data.length > 0 ? data[0].keywords : '';
      keywordsInput.value = keywords;
      keywordsDisplay.textContent = keywords || '-- –Ω–µ –∑–∞–¥–∞–Ω—ã --';
    } catch (error) {
      console.error('loadKeywords: –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', error);
      keywordsDisplay.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    } finally {
      saveBtn.disabled = false;
    }
  }

  async function saveKeywords() {
    if (!keywordsInput) return;
    const kws = keywordsInput.value.trim();
    saveBtn.disabled = true;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—Ç—Ä–æ-–≥–∞–ª–æ—á–∫—É
    const checkmark = createRetroCheckmark();
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '';
    saveBtn.appendChild(checkmark);
    
    try {
      await fetch(API_ENDPOINTS.SETTINGS, {
        method: 'POST',
        headers: createSupabaseHeaders({ prefer: 'resolution=merge-duplicates' }),
        body: JSON.stringify({ update_key: 1, keywords: kws })
      });
      keywordsDisplay.textContent = kws || '-- –Ω–µ –∑–∞–¥–∞–Ω—ã --';
      uiToast(MESSAGES.SUCCESS.KEYWORDS_SAVED);
    } catch (error) {
      console.error('saveKeywords: –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', error);
      safeAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    } finally {
      saveBtn.disabled = false;
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É
      saveBtn.innerHTML = originalText;
    }
  }

  function renderChannel(channel) {
    const channelItem = document.createElement('div');
    channelItem.className = 'channel-item';
    channelItem.dataset.dbId = channel.id;
    
    const infoDiv = document.createElement('div');
    infoDiv.className = 'channel-item-info';
    
    const cleanId = channel.channel_id.replace('@', '');
    const titleSpan = document.createElement('span');
    titleSpan.className = 'channel-item-title';
    // –°–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    titleSpan.textContent = escapeHtml(channel.channel_title || cleanId);
    
    const idLink = document.createElement('a');
    idLink.className = 'channel-item-id';
    idLink.textContent = `@${cleanId}`;
    idLink.href = `https://t.me/${cleanId}`;
    idLink.target = '_blank';
    idLink.rel = 'noopener noreferrer';
    const toggleContainer = document.createElement('div');
    toggleContainer.className = 'channel-item-toggle';
    const toggleLabel = document.createElement('label');
    toggleLabel.className = 'toggle-switch';
    const toggleInput = document.createElement('input');
    toggleInput.type = 'checkbox';
    toggleInput.checked = channel.is_enabled;
    const toggleSlider = document.createElement('span');
    toggleSlider.className = 'toggle-slider';
    const deleteButton = document.createElement('button');
    deleteButton.className = 'channel-item-delete';
    deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    // –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ cleanup
          const deleteHandler = async () => {
        const dbId = channelItem.dataset.dbId;
        if (!dbId) return;
        const ok = await showCustomConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–∞–Ω–∞–ª?');
        if (!ok) return;
        channelItem.style.opacity = '0.5';
        try {
          const response = await fetch(`${API_ENDPOINTS.CHANNELS}?id=eq.${dbId}`, {
            method: 'DELETE',
            headers: createSupabaseHeaders()
          });
          if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ç–∏');
          channelItem.remove();
          uiToast(MESSAGES.SUCCESS.CHANNEL_DELETED);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
          safeAlert(MESSAGES.ERRORS.DELETE_FAILED);
          channelItem.style.opacity = '1';
        }
      };
    
          const toggleHandler = async (event) => {
        const dbId = channelItem.dataset.dbId;
        const is_enabled = event.target.checked;
        if (!dbId) return;
        try {
          const response = await fetch(`${API_ENDPOINTS.CHANNELS}?id=eq.${dbId}`, {
            method: 'PATCH',
            headers: createSupabaseHeaders(),
            body: JSON.stringify({ is_enabled: is_enabled })
          });
          if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ç–∏');
          uiToast(is_enabled ? MESSAGES.SUCCESS.CHANNEL_TOGGLED : MESSAGES.SUCCESS.CHANNEL_DISABLED);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–Ω–∞–ª–∞:', error);
          safeAlert(MESSAGES.ERRORS.UPDATE_FAILED);
          event.target.checked = !is_enabled;
        }
      };
    
    deleteButton.addEventListener('click', deleteHandler);
    toggleInput.addEventListener('change', toggleHandler);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º cleanup —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–µ
    channelItem.cleanup = () => {
      deleteButton.removeEventListener('click', deleteHandler);
      toggleInput.removeEventListener('change', toggleHandler);
    };
    infoDiv.append(titleSpan, idLink);
    toggleLabel.append(toggleInput, toggleSlider);
    toggleContainer.append(toggleLabel);
    channelItem.append(infoDiv, toggleContainer, deleteButton);
    const emptyListMessage = channelsListContainer.querySelector('.empty-list');
    if (emptyListMessage) emptyListMessage.remove();
    channelsListContainer.appendChild(channelItem);
  }
  
  async function addChannel() {
    const channelId = validateAndFormatChannelId(channelInput.value);
    if (!channelId) return;
    
    addChannelBtn.disabled = true;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—Ç—Ä–æ-–ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
    const progressContainer = document.createElement('div');
    progressContainer.style.marginTop = '15px';
    const progress = createRetroProgress(channelId);
    progressContainer.appendChild(progress);
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    const addForm = document.querySelector('.add-channel-form');
    addForm.parentNode.insertBefore(progressContainer, addForm.nextSibling);
    
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
      if (await isChannelExists(channelId)) {
        safeAlert(MESSAGES.ERRORS.CHANNEL_EXISTS);
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª
      await createChannel(channelId);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
      safeAlert(`${MESSAGES.ERRORS.ADD_FAILED}: ${error.message}`);
    } finally {
      addChannelBtn.disabled = false;
      // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
      progressContainer.remove();
    }
  }

  async function loadChannels() {
    if (!channelsListContainer) {
        console.error('loadChannels: —ç–ª–µ–º–µ–Ω—Ç channelsListContainer –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—Ç—Ä–æ-—Å–ø–∏–Ω–Ω–µ—Ä
    const spinner = createRetroSpinner();
    channelsListContainer.innerHTML = '';
    channelsListContainer.appendChild(spinner);
    
    try {
      const response = await fetch(`${API_ENDPOINTS.CHANNELS}?select=*`, {
        headers: createSupabaseHeaders()
      });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const data = await response.json();
      channelsListContainer.innerHTML = '';
      if (data && data.length > 0) {
          data.forEach(item => renderChannel(item));
      } else {
          channelsListContainer.innerHTML = '<p class="empty-list">-- –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –ø—É—Å—Ç --</p>';
      }
    } catch (error) {
      console.error('loadChannels: –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', error);
      channelsListContainer.innerHTML = '<p class="empty-list">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–Ω–∞–ª—ã.</p>';
    }
  }

  addChannelBtn?.addEventListener('click', addChannel);

  saveBtn?.addEventListener('click', () => {
    const activeTab = document.querySelector('.settings-tab-content.active');
    if (activeTab.id === 'tab-keywords') saveKeywords();
    else safeAlert('–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–∞—Ö —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!');
  });

  loadDefaultsBtn?.addEventListener('click', async () => {
    loadDefaultsBtn.disabled = true;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ—Ç—Ä–æ-–ø—Ä–æ–≥—Ä–µ—Å—Å
    const progressContainer = document.createElement('div');
    progressContainer.style.marginTop = '15px';
    const progress = createRetroChannelsProgress(0, 0);
    progressContainer.appendChild(progress);
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏
    loadDefaultsBtn.parentNode.insertBefore(progressContainer, loadDefaultsBtn.nextSibling);
    
    try {
      const response = await fetch(`${API_ENDPOINTS.DEFAULT_CHANNELS}?select=channel_id`, {
        headers: createSupabaseHeaders()
      });
      if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã');
      const defaultChannels = await response.json();
      if (defaultChannels.length === 0) { safeAlert('–°–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –ø—É—Å—Ç.'); return; }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      const progressFill = progress.querySelector('.progress-fill');
      const progressStats = progress.querySelector('.progress-stats');
      
      for (let i = 0; i < defaultChannels.length; i++) {
        const channel = defaultChannels[i];
        await fetch(API_ENDPOINTS.CHANNELS, {
          method: 'POST',
          headers: createSupabaseHeaders({ prefer: 'resolution=merge-duplicates' }),
          body: JSON.stringify({ channel_id: channel.channel_id, is_enabled: true })
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        const percentage = ((i + 1) / defaultChannels.length) * 100;
        progressFill.style.width = `${percentage}%`;
        progressStats.textContent = `–ö–∞–Ω–∞–ª ${i + 1} –∏–∑ ${defaultChannels.length}`;
        
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
        await new Promise(resolve => setTimeout(resolve, 200));
      }
      
      await loadChannels();
      uiToast(MESSAGES.SUCCESS.DEFAULTS_LOADED);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤:', error);
      safeAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
    } finally {
      loadDefaultsBtn.disabled = false;
      // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      progressContainer.remove();
    }
  });

  deleteAllBtn?.addEventListener('click', async () => {
    const message = '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–∞–Ω–∞–ª—ã –∏–∑ –±–∞–∑—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.';
    const isConfirmed = await showCustomConfirm(message);
    if (!isConfirmed) return;
    deleteAllBtn.disabled = true;
    try {
      await fetch(`${API_ENDPOINTS.CHANNELS}?id=gt.0`, {
        method: 'DELETE',
        headers: createSupabaseHeaders()
      });
      channelsListContainer.innerHTML = '<p class="empty-list">-- –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –ø—É—Å—Ç --</p>';
      uiToast(MESSAGES.SUCCESS.ALL_DELETED);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤:', error);
      safeAlert(String(error));
    } finally {
      deleteAllBtn.disabled = false;
    }
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  loadKeywords();
  loadChannels();

  // === –†–ï–¢–†–û-–ì–ï–ô–ú–ò–ù–ì –ü–†–û–ì–†–ï–°–°-–ò–ù–î–ò–ö–ê–¢–û–†–´ ===
  
  /**
   * –°–æ–∑–¥–∞–µ—Ç —Ä–µ—Ç—Ä–æ-—Å–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤
   * @returns {HTMLElement} –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏–Ω–Ω–µ—Ä–∞
   */
  function createRetroSpinner() {
    const spinner = document.createElement('div');
    spinner.className = 'retro-spinner';
    
    const blocks = document.createElement('div');
    blocks.className = 'blocks';
    
    for (let i = 0; i < 6; i++) {
      const block = document.createElement('div');
      block.className = 'block';
      blocks.appendChild(block);
    }
    
    const text = document.createElement('span');
    text.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã...';
    
    spinner.appendChild(blocks);
    spinner.appendChild(text);
    
    return spinner;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç —Ä–µ—Ç—Ä–æ-–ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞
   * @param {string} channelName - –ò–º—è –∫–∞–Ω–∞–ª–∞
   * @returns {HTMLElement} –≠–ª–µ–º–µ–Ω—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
   */
  function createRetroProgress(channelName) {
    const container = document.createElement('div');
    container.className = 'retro-progress';
    
    const text = document.createElement('div');
    text.textContent = `–î–æ–±–∞–≤–ª—è–µ–º ${channelName}...`;
    text.style.textAlign = 'center';
    text.style.marginBottom = '8px';
    text.style.fontFamily = 'var(--font-mono)';
    text.style.fontSize = '14px';
    
    const progressBar = document.createElement('div');
    progressBar.className = 'retro-progress-bar';
    progressBar.style.width = '0%';
    
    container.appendChild(text);
    container.appendChild(progressBar);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    setTimeout(() => {
      progressBar.style.width = '100%';
    }, 100);
    
    return container;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç —Ä–µ—Ç—Ä–æ-—Å—á–µ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤
   * @param {number} current - –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
   * @param {number} total - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
   * @returns {HTMLElement} –≠–ª–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞
   */
  function createRetroCounter(current, total) {
    const counter = document.createElement('div');
    counter.className = 'retro-counter';
    
    const currentSpan = document.createElement('span');
    currentSpan.className = 'current';
    currentSpan.textContent = current;
    
    const separator = document.createElement('span');
    separator.textContent = ' / ';
    separator.style.color = 'var(--hint-color)';
    
    const totalSpan = document.createElement('span');
    totalSpan.className = 'total';
    totalSpan.textContent = total;
    
    counter.appendChild(currentSpan);
    counter.appendChild(separator);
    counter.appendChild(totalSpan);
    
    return counter;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç —Ä–µ—Ç—Ä–æ-–≥–∞–ª–æ—á–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   * @returns {HTMLElement} –≠–ª–µ–º–µ–Ω—Ç –≥–∞–ª–æ—á–∫–∏
   */
  function createRetroCheckmark() {
    const checkmark = document.createElement('div');
    checkmark.className = 'retro-checkmark';
    return checkmark;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç —Ä–µ—Ç—Ä–æ-–ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
   * @param {number} current - –¢–µ–∫—É—â–∏–π –∫–∞–Ω–∞–ª
   * @param {number} total - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤
   * @returns {HTMLElement} –≠–ª–µ–º–µ–Ω—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
   */
  function createRetroChannelsProgress(current, total) {
    const container = document.createElement('div');
    container.className = 'retro-channels-progress';
    
    const progressText = document.createElement('div');
    progressText.className = 'progress-text';
    progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤';
    
    const progressBar = document.createElement('div');
    progressBar.className = 'progress-bar';
    
    const progressFill = document.createElement('div');
    progressFill.className = 'progress-fill';
    progressFill.style.width = `${(current / total) * 100}%`;
    
    const progressStats = document.createElement('div');
    progressStats.className = 'progress-stats';
    progressStats.textContent = `–ö–∞–Ω–∞–ª ${current} –∏–∑ ${total}`;
    
    progressBar.appendChild(progressFill);
    container.appendChild(progressText);
    container.appendChild(progressBar);
    container.appendChild(progressStats);
    
    return container;
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
   * @param {HTMLElement} container - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–∫–∞–∑–∞
   * @param {HTMLElement} indicator - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –ø–æ–∫–∞–∑–∞
   */
  function showProgress(container, indicator) {
    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    container.innerHTML = '';
    container.appendChild(indicator);
  }

  /**
   * –°–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
   * @param {HTMLElement} container - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä
   * @param {string} originalContent - –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
   */
  function hideProgress(container, originalContent) {
    container.innerHTML = originalContent;
  }
})();
